<html>
    <head>
        <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
        <title>
            LAN-Gymnasium online Klassenbuch
        </title>
         <link rel="stylesheet" href="style/webpage.css" type="text/css">
    </head>
    <body>
	<script src="javascript/script.js"></script>
	<script src="javascript/jquery-2.1.4.min.js"></script>
	<script>
		var user;
		var userSchool;
		var footerEventCount;
		var date;
		var student;
		var teacher;
		
		window.addEventListener("OnFooterLoaded", function(e) {
			if(footerEventCount >= 1){ 
				$('#footer_txt_logininfo').prepend(document.createTextNode('Angemeldet im ' + userSchool.name + ' als '));
				
				$('#footer_txt_logininfo').append(document.createTextNode(user.firstName + ' ' + user.familyName));
			}
			else{
				footerEventCount++;
			}
		})
		
		window.addEventListener("OnDataLoaded", function (e) {
			if(e.detail.userLoaded){
				if(getUrlParameter("noteID") == -1){
					$('#note_inpt_tName').prop("value", user.firstName + " " + user.familyName);
				}
			}
			if(e.detail.studentLoaded){
				$('#note_inpt_pName').prop("value", student.firstName + " " + student.familyName);
			}
			if(e.detail.teacherLoaded){
				$('#note_inpt_tName').prop("value", teacher.firstName + " " + teacher.familyName);
			}
		})
		
		window.addEventListener("DOMContentLoaded", function(){
			footerEventCount=0;
			$.getJSON("/rest/user/loggedInUser", function(user) {
				setUser(user);
				var evt = new CustomEvent("OnFooterLoaded", {});
				window.dispatchEvent(evt);
			})
			
			$.getJSON("/rest/user/userSchool", function(school) {
				setUserSchool(school);
				var evt = new CustomEvent("OnFooterLoaded", {});
				window.dispatchEvent(evt);
			})
			
			setFields();
		});
		
		function setUserSchool(school){
			this.userSchool = school;
		}
		
		function setFields(){
			var noteID = getUrlParameter("noteID");
			var studentID = getUrlParameter("studentID");

			if(noteID == -1){
				$.getJSON("/rest/user/" + studentID, function(student) {
					setStudent(student);
					setDate();
				})
			}
			else{
				
				$.getJSON("/rest/note/" + noteID, function(note) {					
					$.getJSON("/rest/user/" + note.teacher, function(teacher) {
						setTeacher(teacher);
					})
					var noteDate = new Date(note.timestamp);
					$('#note_inpt_ts').prop("value", noteDate.toLocaleString());
					setTimeout(function(){date = new Date();}, 1000);
					$('#note_txtArea_content').prop("value", note.text);
					$.getJSON("/rest/user/" + note.student, function(student) {
						setStudent(student);
					})
				})
			}
		}
		
		function setDate(){
			date = new Date();
			if(getUrlParameter("noteID") == -1){
				$('#note_inpt_ts').prop("value", date.toLocaleString());
			}
			setTimeout(setDate, 500);
		}
		
		function setUser(user){
			this.user = user;
			var evt = new CustomEvent("OnDataLoaded", {detail: {userLoaded:true, studentLoaded:false, teacherLoaded:false}});
			window.dispatchEvent(evt);
		}
		
		function setStudent(student){
			this.student = student;
			var evt = new CustomEvent("OnDataLoaded", {detail: {userLoaded:false, studentLoaded:true, teacherLoaded:false}});
			window.dispatchEvent(evt);
		}
		
		function setTeacher(teacher){
			this.teacher = teacher;
			var evt = new CustomEvent("OnDataLoaded", {detail: {userLoaded:false, studentLoaded:false, teacherLoaded:true}});
			console.debug(evt);
			window.dispatchEvent(evt);
		}
		
		function saveNote(){
			var noteObject = {teacher:user.key.id, timestamp:date.getTime(), student:student.key.id, text:$('#note_txtArea_content').prop("value")};
			console.debug(noteObject);
			
			$.ajaxSetup({
				  contentType: "application/json; charset=utf-8"
			});
			if(getUrlParameter("noteID") != -1){
				$.ajax({
					url: "/rest/note/" + getUrlParameter("noteID"),
					contentType: "application/json; charset=utf-8",
					type: "DELETE", 
					mimeType: "application/json",
					success: function(data){
					}
				})
			}
			
			
			$.ajax({
				url: "/rest/note/",
				contentType: "application/json; charset=utf-8",
				type: "POST", 
				mimeType: "application/json",
				data: JSON.stringify(noteObject),
				success: function(data){
					location.replace(document.referrer);
				}
			})
			
		}
	</script>
		<header>
			<nav id="doc_navlist">
				<ul>
					<li> </li>
					<li>
						<a href="./mylan.html">MyLAN</a>
					</li> 
					<li>
						<a href="./teachers.html">Lehrer</a>
					</li> 
					<li>
						<a href="./classes.html">Klassen</a>
					</li> 
					<li>
						<a href="./pupils.html">Sch&uuml;ler</a>
					</li>
					<li>
						<a href="./maint.html">Verwalten</a>
					</li>

					<li id="current">
						<a href="./note.html">Notiz</a>
					</li>
					<li> </li>
					<li id="justifier"> </li>
				</ul>
			</nav>
		</header>
		
		
		<div id="pagecontent">
			<form>
				<div id="note_inpt_metadata">
					<span>
						<label for="teacher">Lehrer:</label>
						<input type="text" name="teacher" value="" id="note_inpt_tName" readonly>
					</span>
					<span>
						<label for="timestamp">Erfassungszeitpunkt:</label>
						<input type="text" name="timestamp" value="" id="note_inpt_ts" readonly>
					</span>
					<span>
						<label for="pupil">Sch&uumller: </label>
						<input type="text" name="pupil" value="" id="note_inpt_pName" readonly>
					</span>
					<div id="note_btn_sla">
						<input type="button" value="Abbrechen" id="login_bt" onclick="onclickReturnToPupils()"/>
						<input type="button" value="Speichern" id="login_bt" onclick="saveNote()"/>
					</div>
				</div>
			
				<div id="note_content">
					<textarea id="note_txtArea_content"></textarea>
				</div>
			</form>
		</div>
		
		<footer>
			<div id="footer_logoutbar">
				<p id="footer_txt_logininfo"></p>
				<a href='logout' id="footer_a_logout">> Abmelden &lt;</a>
			</div>
		</footer>
    </body>
</html>